Linux more
---





## 1 Linux çš„å¯åŠ¨æµç¨‹

https://www.ruanyifeng.com/blog/2013/08/linux_boot_process.html

**è®¡ç®—æœºå¯åŠ¨æµç¨‹**ï¼š

![](images/bg2013081701.png)

æ“ä½œç³»ç»ŸæŽ¥ç®¡ç¡¬ä»¶ä»¥åŽï¼Œå°±æ˜¯**æ“ä½œç³»ç»Ÿçš„å¯åŠ¨æµç¨‹**ã€‚è¿™ä¸ªéƒ¨åˆ†æ¯”è¾ƒæœ‰æ„æ€ã€‚å› ä¸ºåœ¨BIOSé˜¶æ®µï¼Œè®¡ç®—æœºçš„è¡Œä¸ºåŸºæœ¬ä¸Šè¢«å†™æ­»äº†ï¼Œç¨‹åºå‘˜å¯ä»¥åšçš„äº‹æƒ…å¹¶ä¸å¤šï¼›ä½†æ˜¯ï¼Œä¸€æ—¦è¿›å…¥æ“ä½œç³»ç»Ÿï¼Œç¨‹åºå‘˜å‡ ä¹Žå¯ä»¥å®šåˆ¶æ‰€æœ‰æ–¹é¢ã€‚

é’ˆå¯¹Debain

### ç¬¬ä¸€æ­¥ã€åŠ è½½å†…æ ¸

![](images/bg2013081702.png)

### ç¬¬äºŒæ­¥ã€å¯åŠ¨åˆå§‹åŒ–è¿›ç¨‹

å†…æ ¸æ–‡ä»¶åŠ è½½ä»¥åŽï¼Œå°±å¼€å§‹è¿è¡Œç¬¬ä¸€ä¸ªç¨‹åº `/sbin/init`ï¼Œå®ƒçš„ä½œç”¨æ˜¯**åˆå§‹åŒ–ç³»ç»ŸçŽ¯å¢ƒ**ã€‚

![](images/bg2013081703.png)

ç”±äºŽinitæ˜¯ç¬¬ä¸€ä¸ªè¿è¡Œçš„ç¨‹åºï¼Œå®ƒçš„è¿›ç¨‹ç¼–å·ï¼ˆpidï¼‰å°±æ˜¯1ã€‚å…¶ä»–æ‰€æœ‰è¿›ç¨‹éƒ½ä»Žå®ƒè¡ç”Ÿï¼Œéƒ½æ˜¯å®ƒçš„å­è¿›ç¨‹ã€‚

### ç¬¬ä¸‰æ­¥ã€ç¡®å®šè¿è¡Œçº§åˆ«

è®¸å¤šç¨‹åºéœ€è¦å¼€æœºå¯åŠ¨ã€‚å®ƒä»¬åœ¨Windowså«åš"æœåŠ¡"ï¼ˆserviceï¼‰ï¼Œåœ¨Linuxå°±å«åš"å®ˆæŠ¤è¿›ç¨‹"ï¼ˆdaemonï¼‰ã€‚

initè¿›ç¨‹çš„ä¸€å¤§ä»»åŠ¡ï¼Œå°±æ˜¯åŽ»è¿è¡Œè¿™äº›å¼€æœºå¯åŠ¨çš„ç¨‹åºã€‚ä½†æ˜¯ï¼Œä¸åŒçš„åœºåˆéœ€è¦å¯åŠ¨ä¸åŒçš„ç¨‹åºï¼Œæ¯”å¦‚ç”¨ä½œæœåŠ¡å™¨æ—¶ï¼Œéœ€è¦å¯åŠ¨Apacheï¼Œç”¨ä½œæ¡Œé¢å°±ä¸éœ€è¦ã€‚Linuxå…è®¸ä¸ºä¸åŒçš„åœºåˆï¼Œåˆ†é…ä¸åŒçš„å¼€æœºå¯åŠ¨ç¨‹åºï¼Œè¿™å°±å«åš"è¿è¡Œçº§åˆ«"ï¼ˆrunlevelï¼‰ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯åŠ¨æ—¶æ ¹æ®"è¿è¡Œçº§åˆ«"ï¼Œç¡®å®šè¦è¿è¡Œå“ªäº›ç¨‹åºã€‚

![](images/bg2013081704.png)

Linuxé¢„ç½®ä¸ƒç§è¿è¡Œçº§åˆ«ï¼ˆ0-6ï¼‰ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œ0æ˜¯å…³æœºï¼Œ1æ˜¯å•ç”¨æˆ·æ¨¡å¼ï¼ˆä¹Ÿå°±æ˜¯ç»´æŠ¤æ¨¡å¼ï¼‰ï¼Œ6æ˜¯é‡å¯ã€‚è¿è¡Œçº§åˆ«2-5ï¼Œå„ä¸ªå‘è¡Œç‰ˆä¸å¤ªä¸€æ ·ï¼Œå¯¹äºŽDebianæ¥è¯´ï¼Œéƒ½æ˜¯åŒæ ·çš„å¤šç”¨æˆ·æ¨¡å¼ï¼ˆä¹Ÿå°±æ˜¯æ­£å¸¸æ¨¡å¼ï¼‰ã€‚

initè¿›ç¨‹é¦–å…ˆè¯»å–æ–‡ä»¶ `/etc/inittab`ï¼Œå®ƒæ˜¯è¿è¡Œçº§åˆ«çš„è®¾ç½®æ–‡ä»¶ã€‚

### ç¬¬å››æ­¥ã€åŠ è½½å¼€æœºå¯åŠ¨ç¨‹åº

å‰é¢æåˆ°ï¼Œä¸ƒç§é¢„è®¾çš„"è¿è¡Œçº§åˆ«"å„è‡ªæœ‰ä¸€ä¸ªç›®å½•ï¼Œå­˜æ”¾éœ€è¦å¼€æœºå¯åŠ¨çš„ç¨‹åºã€‚ä¸éš¾æƒ³åˆ°ï¼Œå¦‚æžœå¤šä¸ª"è¿è¡Œçº§åˆ«"éœ€è¦å¯åŠ¨åŒä¸€ä¸ªç¨‹åºï¼Œé‚£ä¹ˆè¿™ä¸ªç¨‹åºçš„å¯åŠ¨è„šæœ¬ï¼Œå°±ä¼šåœ¨æ¯ä¸€ä¸ªç›®å½•é‡Œéƒ½æœ‰ä¸€ä¸ªæ‹·è´ã€‚è¿™æ ·ä¼šé€ æˆç®¡ç†ä¸Šçš„å›°æ‰°ï¼šå¦‚æžœè¦ä¿®æ”¹å¯åŠ¨è„šæœ¬ï¼Œå²‚ä¸æ˜¯æ¯ä¸ªç›®å½•éƒ½è¦æ”¹ä¸€éï¼Ÿ

Linuxçš„è§£å†³åŠžæ³•ï¼Œå°±æ˜¯ä¸ƒä¸ª `/etc/rcN.d` ç›®å½•é‡Œåˆ—å‡ºçš„ç¨‹åºï¼Œéƒ½è®¾ä¸ºé“¾æŽ¥æ–‡ä»¶ï¼ŒæŒ‡å‘å¦å¤–ä¸€ä¸ªç›®å½• `/etc/init.d` ï¼ŒçœŸæ­£çš„å¯åŠ¨è„šæœ¬éƒ½ç»Ÿä¸€æ”¾åœ¨è¿™ä¸ªç›®å½•ä¸­ã€‚initè¿›ç¨‹é€ä¸€åŠ è½½å¼€æœºå¯åŠ¨ç¨‹åºï¼Œå…¶å®žå°±æ˜¯è¿è¡Œè¿™ä¸ªç›®å½•é‡Œçš„å¯åŠ¨è„šæœ¬ã€‚

![](images/bg2013081705.png)

### ç¬¬äº”æ­¥ã€ç”¨æˆ·ç™»å½•

![img](images/bg2013081706.png)

ä¸€èˆ¬æ¥è¯´ï¼Œç”¨æˆ·çš„ç™»å½•æ–¹å¼æœ‰ä¸‰ç§ï¼šå‘½ä»¤è¡Œç™»å½•ã€sshç™»å½•ã€å›¾å½¢ç•Œé¢ç™»å½•

è¿™ä¸‰ç§æƒ…å†µï¼Œéƒ½æœ‰è‡ªå·±çš„æ–¹å¼å¯¹ç”¨æˆ·è¿›è¡Œè®¤è¯ã€‚

1. å‘½ä»¤è¡Œç™»å½•ï¼šinitè¿›ç¨‹è°ƒç”¨gettyç¨‹åºï¼ˆæ„ä¸ºget teletypeï¼‰ï¼Œè®©ç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚è¾“å…¥å®ŒæˆåŽï¼Œå†è°ƒç”¨loginç¨‹åºï¼Œæ ¸å¯¹å¯†ç ï¼ˆDebianè¿˜ä¼šå†å¤šè¿è¡Œä¸€ä¸ªèº«ä»½æ ¸å¯¹ç¨‹åº/etc/pam.d/loginï¼‰ã€‚å¦‚æžœå¯†ç æ­£ç¡®ï¼Œå°±ä»Žæ–‡ä»¶ /etc/passwd è¯»å–è¯¥ç”¨æˆ·æŒ‡å®šçš„shellï¼Œç„¶åŽå¯åŠ¨è¿™ä¸ªshellã€‚

2. sshç™»å½•ï¼šè¿™æ—¶ç³»ç»Ÿè°ƒç”¨`sshd`ç¨‹åºï¼ˆDebianè¿˜ä¼šå†è¿è¡Œ/etc/pam.d/ssh ï¼‰ï¼Œå–ä»£gettyå’Œloginï¼Œç„¶åŽå¯åŠ¨shellã€‚

3. å›¾å½¢ç•Œé¢ç™»å½•ï¼šinitè¿›ç¨‹è°ƒç”¨æ˜¾ç¤ºç®¡ç†å™¨ï¼ŒGnomeå›¾å½¢ç•Œé¢å¯¹åº”çš„æ˜¾ç¤ºç®¡ç†å™¨ä¸ºgdmï¼ˆGNOME Display Managerï¼‰ï¼Œç„¶åŽç”¨æˆ·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ã€‚å¦‚æžœå¯†ç æ­£ç¡®ï¼Œå°±è¯»å–/etc/gdm3/Xsessionï¼Œå¯åŠ¨ç”¨æˆ·çš„ä¼šè¯ã€‚

### ç¬¬å…­æ­¥ã€è¿›å…¥ login shell

æ‰€è°“shellï¼Œç®€å•è¯´å°±æ˜¯å‘½ä»¤è¡Œç•Œé¢ï¼Œè®©ç”¨æˆ·å¯ä»¥ç›´æŽ¥ä¸Žæ“ä½œç³»ç»Ÿå¯¹è¯ã€‚ç”¨æˆ·ç™»å½•æ—¶æ‰“å¼€çš„shellï¼Œå°±å«åšlogin shellã€‚

![](images/bg2013081707.png)

Debiané»˜è®¤çš„shellæ˜¯Bashï¼Œå®ƒä¼šè¯»å…¥ä¸€ç³»åˆ—çš„é…ç½®æ–‡ä»¶ã€‚ä¸Šä¸€æ­¥çš„ä¸‰ç§æƒ…å†µï¼Œåœ¨è¿™ä¸€æ­¥çš„å¤„ç†ï¼Œä¹Ÿå­˜åœ¨å·®å¼‚ã€‚

1. å‘½ä»¤è¡Œç™»å½•ï¼šé¦–å…ˆè¯»å…¥ `/etc/profile`ï¼Œè¿™æ˜¯å¯¹æ‰€æœ‰ç”¨æˆ·éƒ½æœ‰æ•ˆçš„é…ç½®ï¼›ç„¶åŽä¾æ¬¡å¯»æ‰¾ä¸‹é¢ä¸‰ä¸ªæ–‡ä»¶ï¼Œè¿™æ˜¯é’ˆå¯¹å½“å‰ç”¨æˆ·çš„é…ç½®ã€‚

```shell
~/.bash_profile
~/.bash_login
~/.profile
```


éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œè¿™ä¸‰ä¸ªæ–‡ä»¶åªè¦æœ‰ä¸€ä¸ªå­˜åœ¨ï¼Œå°±ä¸å†è¯»å…¥åŽé¢çš„æ–‡ä»¶äº†ã€‚æ¯”å¦‚ï¼Œè¦æ˜¯ `~/.bash_profile` å­˜åœ¨ï¼Œå°±ä¸ä¼šå†è¯»å…¥åŽé¢ä¸¤ä¸ªæ–‡ä»¶äº†ã€‚

2. sshç™»å½•ï¼šä¸Žç¬¬ä¸€ç§æƒ…å†µå®Œå…¨ç›¸åŒã€‚

3. å›¾å½¢ç•Œé¢ç™»å½•ï¼šåªåŠ è½½ `/etc/profile` å’Œ `~/.profile`ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œ`~/.bash_profile` ä¸ç®¡æœ‰æ²¡æœ‰ï¼Œéƒ½ä¸ä¼šè¿è¡Œã€‚

### ç¬¬ä¸ƒæ­¥ï¼Œæ‰“å¼€ non-login shell

è€å®žè¯´ï¼Œä¸Šä¸€æ­¥å®Œæˆä»¥åŽï¼ŒLinuxçš„å¯åŠ¨è¿‡ç¨‹å°±ç®—ç»“æŸäº†ï¼Œç”¨æˆ·å·²ç»å¯ä»¥çœ‹åˆ°å‘½ä»¤è¡Œæç¤ºç¬¦æˆ–è€…å›¾å½¢ç•Œé¢äº†ã€‚ä½†æ˜¯ï¼Œä¸ºäº†å†…å®¹çš„å®Œæ•´ï¼Œå¿…é¡»å†ä»‹ç»ä¸€ä¸‹è¿™ä¸€æ­¥ã€‚

ç”¨æˆ·è¿›å…¥æ“ä½œç³»ç»Ÿä»¥åŽï¼Œå¸¸å¸¸ä¼šå†æ‰‹åŠ¨å¼€å¯ä¸€ä¸ªshellã€‚è¿™ä¸ªshellå°±å«åš non-login shellï¼Œæ„æ€æ˜¯å®ƒä¸åŒäºŽç™»å½•æ—¶å‡ºçŽ°çš„é‚£ä¸ªshellï¼Œä¸è¯»å–/etc/profileå’Œ.profileç­‰é…ç½®æ–‡ä»¶ã€‚

![](images/bg2013081708.png)

non-login shellçš„é‡è¦æ€§ï¼Œä¸ä»…åœ¨äºŽå®ƒæ˜¯ç”¨æˆ·æœ€å¸¸æŽ¥è§¦çš„é‚£ä¸ªshellï¼Œè¿˜åœ¨äºŽå®ƒä¼šè¯»å…¥ç”¨æˆ·è‡ªå·±çš„bashé…ç½®æ–‡ä»¶ `~/.bashrc`ã€‚å¤§å¤šæ•°æ—¶å€™ï¼Œæˆ‘ä»¬å¯¹äºŽbashçš„å®šåˆ¶ï¼Œéƒ½æ˜¯å†™åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œé¢çš„ã€‚

ä½ ä¹Ÿè®¸ä¼šé—®ï¼Œè¦æ˜¯ä¸è¿›å…¥ non-login shellï¼Œå²‚ä¸æ˜¯.bashrcå°±ä¸ä¼šè¿è¡Œäº†ï¼Œå› æ­¤bash ä¹Ÿå°±ä¸èƒ½å®Œæˆå®šåˆ¶äº†ï¼Ÿäº‹å®žä¸Šï¼ŒDebianå·²ç»è€ƒè™‘åˆ°è¿™ä¸ªé—®é¢˜äº†ï¼Œè¯·æ‰“å¼€æ–‡ä»¶ `~/.profile`ï¼Œå¯ä»¥çœ‹åˆ°ä¸‹é¢çš„ä»£ç ï¼š

```shell
if [ -n "$BASH_VERSION" ]; then
  if [ -f "$HOME/.bashrc" ]; then
  	. "$HOME/.bashrc"
  fi
fi
```

ä¸Šé¢ä»£ç å…ˆåˆ¤æ–­å˜é‡ $BASH_VERSION æ˜¯å¦æœ‰å€¼ï¼Œç„¶åŽåˆ¤æ–­ä¸»ç›®å½•ä¸‹æ˜¯å¦å­˜åœ¨ .bashrc æ–‡ä»¶ï¼Œå¦‚æžœå­˜åœ¨å°±è¿è¡Œè¯¥æ–‡ä»¶ã€‚ç¬¬ä¸‰è¡Œå¼€å¤´çš„é‚£ä¸ª**ç‚¹ï¼Œæ˜¯sourceå‘½ä»¤çš„ç®€å†™å½¢å¼**ï¼Œè¡¨ç¤ºè¿è¡ŒæŸä¸ªæ–‡ä»¶ï¼Œå†™æˆ"source ~/.bashrc"ä¹Ÿæ˜¯å¯ä»¥çš„ã€‚

å› æ­¤ï¼Œåªè¦è¿è¡Œï½ž/.profileæ–‡ä»¶ï¼Œï½ž/.bashrcæ–‡ä»¶å°±ä¼šè¿žå¸¦è¿è¡Œã€‚ä½†æ˜¯ä¸Šä¸€èŠ‚çš„ç¬¬ä¸€ç§æƒ…å†µæåˆ°è¿‡ï¼Œå¦‚æžœå­˜åœ¨ï½ž/.bash_profileæ–‡ä»¶ï¼Œé‚£ä¹ˆæœ‰å¯èƒ½ä¸ä¼šè¿è¡Œï½ž/.profileæ–‡ä»¶ã€‚è§£å†³è¿™ä¸ªé—®é¢˜å¾ˆç®€å•ï¼ŒæŠŠä¸‹é¢ä»£ç å†™å…¥.bash_profileå°±è¡Œäº†ã€‚

```shell
if [ -f ~/.profile ]; then
	. ~/.profile
fi
```

è¿™æ ·ä¸€æ¥ï¼Œä¸ç®¡æ˜¯å“ªç§æƒ…å†µï¼Œ.bashrcéƒ½ä¼šæ‰§è¡Œï¼Œç”¨æˆ·çš„è®¾ç½®å¯ä»¥æ”¾å¿ƒåœ°éƒ½å†™å…¥è¿™ä¸ªæ–‡ä»¶äº†ã€‚

Bashçš„è®¾ç½®ä¹‹æ‰€ä»¥å¦‚æ­¤ç¹çï¼Œæ˜¯ç”±äºŽåŽ†å²åŽŸå› é€ æˆçš„ã€‚æ—©æœŸçš„æ—¶å€™ï¼Œè®¡ç®—æœºè¿è¡Œé€Ÿåº¦å¾ˆæ…¢ï¼Œè½½å…¥é…ç½®æ–‡ä»¶éœ€è¦å¾ˆé•¿æ—¶é—´ï¼ŒBashçš„ä½œè€…åªå¥½æŠŠé…ç½®æ–‡ä»¶åˆ†æˆäº†å‡ ä¸ªéƒ¨åˆ†ï¼Œé˜¶æ®µæ€§è½½å…¥ã€‚ç³»ç»Ÿçš„é€šç”¨è®¾ç½®æ”¾åœ¨ /etc/profileï¼Œç”¨æˆ·ä¸ªäººçš„ã€éœ€è¦è¢«æ‰€æœ‰å­è¿›ç¨‹ç»§æ‰¿çš„è®¾ç½®æ”¾åœ¨.profileï¼Œä¸éœ€è¦è¢«ç»§æ‰¿çš„è®¾ç½®æ”¾åœ¨.bashrcã€‚

é¡ºä¾¿æä¸€ä¸‹ï¼Œé™¤äº†Linuxä»¥å¤–ï¼Œ Mac OS X ä½¿ç”¨çš„shellä¹Ÿæ˜¯Bashã€‚ä½†æ˜¯ï¼Œå®ƒåªåŠ è½½.bash_profileï¼Œç„¶åŽåœ¨.bash_profileé‡Œé¢è°ƒç”¨.bashrcã€‚è€Œä¸”ï¼Œä¸ç®¡æ˜¯sshç™»å½•ï¼Œè¿˜æ˜¯åœ¨å›¾å½¢ç•Œé¢é‡Œå¯åŠ¨shellçª—å£ï¼Œéƒ½æ˜¯å¦‚æ­¤ã€‚

## Systemd

Systemd æ˜¯ Linux ç³»ç»Ÿå·¥å…·ï¼Œç”¨æ¥å¯åŠ¨å®ˆæŠ¤è¿›ç¨‹ï¼Œå·²æˆä¸ºå¤§å¤šæ•°å‘è¡Œç‰ˆçš„æ ‡å‡†é…ç½®ã€‚

https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html

https://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html

https://www.ruanyifeng.com/blog/2018/03/systemd-timer.html

### ç”±æ¥

åŽ†å²ä¸Šï¼ŒLinux çš„å¯åŠ¨ä¸€ç›´é‡‡ç”¨initè¿›ç¨‹ã€‚ä¸‹é¢çš„å‘½ä»¤ç”¨æ¥å¯åŠ¨æœåŠ¡ã€‚

```shell
$ sudo /etc/init.d/apache2 start
# æˆ–è€…
$ service apache2 start
```

è¿™ç§æ–¹æ³•æœ‰ä¸¤ä¸ªç¼ºç‚¹ã€‚

- ä¸€æ˜¯å¯åŠ¨æ—¶é—´é•¿ã€‚initè¿›ç¨‹æ˜¯ä¸²è¡Œå¯åŠ¨ï¼Œåªæœ‰å‰ä¸€ä¸ªè¿›ç¨‹å¯åŠ¨å®Œï¼Œæ‰ä¼šå¯åŠ¨ä¸‹ä¸€ä¸ªè¿›ç¨‹ã€‚

- äºŒæ˜¯å¯åŠ¨è„šæœ¬å¤æ‚ã€‚initè¿›ç¨‹åªæ˜¯æ‰§è¡Œå¯åŠ¨è„šæœ¬ï¼Œä¸ç®¡å…¶ä»–äº‹æƒ…ã€‚è„šæœ¬éœ€è¦è‡ªå·±å¤„ç†å„ç§æƒ…å†µï¼Œè¿™å¾€å¾€ä½¿å¾—è„šæœ¬å˜å¾—å¾ˆé•¿ã€‚

### Systemd æ¦‚è¿°

Systemd å°±æ˜¯ä¸ºäº†è§£å†³è¿™äº›é—®é¢˜è€Œè¯žç”Ÿçš„ã€‚å®ƒçš„è®¾è®¡ç›®æ ‡æ˜¯ï¼Œä¸ºç³»ç»Ÿçš„å¯åŠ¨å’Œç®¡ç†æä¾›ä¸€å¥—å®Œæ•´çš„è§£å†³æ–¹æ¡ˆã€‚

æ ¹æ® Linux æƒ¯ä¾‹ï¼Œå­—æ¯`d`æ˜¯å®ˆæŠ¤è¿›ç¨‹ï¼ˆdaemonï¼‰çš„ç¼©å†™ã€‚ Systemd è¿™ä¸ªåå­—çš„å«ä¹‰ï¼Œå°±æ˜¯å®ƒè¦å®ˆæŠ¤æ•´ä¸ªç³»ç»Ÿã€‚

ä½¿ç”¨äº† Systemdï¼Œå°±ä¸éœ€è¦å†ç”¨`init`äº†ã€‚Systemd å–ä»£äº†`initd`ï¼Œæˆä¸ºç³»ç»Ÿçš„ç¬¬ä¸€ä¸ªè¿›ç¨‹ï¼ˆPID ç­‰äºŽ 1ï¼‰ï¼Œå…¶ä»–è¿›ç¨‹éƒ½æ˜¯å®ƒçš„å­è¿›ç¨‹ã€‚

Systemd çš„ä¼˜ç‚¹æ˜¯**åŠŸèƒ½å¼ºå¤§ï¼Œä½¿ç”¨æ–¹ä¾¿**ï¼Œç¼ºç‚¹æ˜¯**ä½“ç³»åºžå¤§ï¼Œéžå¸¸å¤æ‚**ã€‚äº‹å®žä¸Šï¼ŒçŽ°åœ¨è¿˜æœ‰å¾ˆå¤šäººåå¯¹ä½¿ç”¨ Systemdï¼Œç†ç”±å°±æ˜¯å®ƒè¿‡äºŽå¤æ‚ï¼Œä¸Žæ“ä½œç³»ç»Ÿçš„å…¶ä»–éƒ¨åˆ†å¼ºè€¦åˆï¼Œè¿å"keep simple, keep stupid"çš„Unix å“²å­¦ã€‚

![Systemd æž¶æž„å›¾](images/bg2016030703.png)

### ç³»ç»Ÿç®¡ç†

Systemd å¹¶ä¸æ˜¯ä¸€ä¸ªå‘½ä»¤ï¼Œè€Œæ˜¯ä¸€ç»„å‘½ä»¤ï¼Œæ¶‰åŠåˆ°ç³»ç»Ÿç®¡ç†çš„æ–¹æ–¹é¢é¢ã€‚

#### systemctl

`systemctl`æ˜¯ Systemd çš„ä¸»å‘½ä»¤ï¼Œç”¨äºŽç®¡ç†ç³»ç»Ÿã€‚

```bash
# é‡å¯ç³»ç»Ÿ
$ sudo systemctl reboot

# å…³é—­ç³»ç»Ÿï¼Œåˆ‡æ–­ç”µæº
$ sudo systemctl poweroff

# CPUåœæ­¢å·¥ä½œ
$ sudo systemctl halt

# æš‚åœç³»ç»Ÿ
$ sudo systemctl suspend

# è®©ç³»ç»Ÿè¿›å…¥å†¬çœ çŠ¶æ€
$ sudo systemctl hibernate

# è®©ç³»ç»Ÿè¿›å…¥äº¤äº’å¼ä¼‘çœ çŠ¶æ€
$ sudo systemctl hybrid-sleep

# å¯åŠ¨è¿›å…¥æ•‘æ´çŠ¶æ€ï¼ˆå•ç”¨æˆ·çŠ¶æ€ï¼‰
$ sudo systemctl rescue
```

#### systemd-analyze

`systemd-analyze`å‘½ä»¤ç”¨äºŽæŸ¥çœ‹å¯åŠ¨è€—æ—¶ã€‚

```bash
# æŸ¥çœ‹å¯åŠ¨è€—æ—¶
$ systemd-analyze                                                                                       

# æŸ¥çœ‹æ¯ä¸ªæœåŠ¡çš„å¯åŠ¨è€—æ—¶
$ systemd-analyze blame

# æ˜¾ç¤ºç€‘å¸ƒçŠ¶çš„å¯åŠ¨è¿‡ç¨‹æµ
$ systemd-analyze critical-chain

# æ˜¾ç¤ºæŒ‡å®šæœåŠ¡çš„å¯åŠ¨æµ
$ systemd-analyze critical-chain atd.service
```

#### hostnamectl

`hostnamectl`å‘½ä»¤ç”¨äºŽæŸ¥çœ‹å½“å‰ä¸»æœºçš„ä¿¡æ¯ã€‚

```bash
# æ˜¾ç¤ºå½“å‰ä¸»æœºçš„ä¿¡æ¯
$ hostnamectl

# è®¾ç½®ä¸»æœºåã€‚
$ sudo hostnamectl set-hostname rhel7
```

#### localectl

`localectl`å‘½ä»¤ç”¨äºŽæŸ¥çœ‹æœ¬åœ°åŒ–è®¾ç½®ã€‚

```bash
# æŸ¥çœ‹æœ¬åœ°åŒ–è®¾ç½®
$ localectl

# è®¾ç½®æœ¬åœ°åŒ–å‚æ•°ã€‚
$ sudo localectl set-locale LANG=en_GB.utf8
$ sudo localectl set-keymap en_GB
```

#### timedatectl

`timedatectl`å‘½ä»¤ç”¨äºŽæŸ¥çœ‹å½“å‰æ—¶åŒºè®¾ç½®ã€‚

```bash
# æŸ¥çœ‹å½“å‰æ—¶åŒºè®¾ç½®
$ timedatectl

# æ˜¾ç¤ºæ‰€æœ‰å¯ç”¨çš„æ—¶åŒº
$ timedatectl list-timezones                                                                                   

# è®¾ç½®å½“å‰æ—¶åŒº
$ sudo timedatectl set-timezone America/New_York
$ sudo timedatectl set-time YYYY-MM-DD
$ sudo timedatectl set-time HH:MM:SS
```

#### loginctl

`loginctl`å‘½ä»¤ç”¨äºŽæŸ¥çœ‹å½“å‰ç™»å½•çš„ç”¨æˆ·ã€‚

```bash
# åˆ—å‡ºå½“å‰session
$ loginctl list-sessions

# åˆ—å‡ºå½“å‰ç™»å½•ç”¨æˆ·
$ loginctl list-users

# åˆ—å‡ºæ˜¾ç¤ºæŒ‡å®šç”¨æˆ·çš„ä¿¡æ¯
$ loginctl show-user ruanyf
```



### Unit

Systemd å¯ä»¥ç®¡ç†æ‰€æœ‰ç³»ç»Ÿèµ„æºã€‚ä¸åŒçš„èµ„æºç»Ÿç§°ä¸º Unitï¼ˆå•ä½ï¼‰ã€‚

Unit ä¸€å…±åˆ†æˆ12ç§ã€‚

- Service unitï¼šç³»ç»ŸæœåŠ¡
- Target unitï¼šå¤šä¸ª Unit æž„æˆçš„ä¸€ä¸ªç»„
- Device Unitï¼šç¡¬ä»¶è®¾å¤‡
- Mount Unitï¼šæ–‡ä»¶ç³»ç»Ÿçš„æŒ‚è½½ç‚¹
- Automount Unitï¼šè‡ªåŠ¨æŒ‚è½½ç‚¹
- Path Unitï¼šæ–‡ä»¶æˆ–è·¯å¾„
- Scope Unitï¼šä¸æ˜¯ç”± Systemd å¯åŠ¨çš„å¤–éƒ¨è¿›ç¨‹
- Slice Unitï¼šè¿›ç¨‹ç»„
- Snapshot Unitï¼šSystemd å¿«ç…§ï¼Œå¯ä»¥åˆ‡å›žæŸä¸ªå¿«ç…§
- Socket Unitï¼šè¿›ç¨‹é—´é€šä¿¡çš„ socket
- Swap Unitï¼šswap æ–‡ä»¶
- Timer Unitï¼šå®šæ—¶å™¨

```bash
# åˆ—å‡ºæ­£åœ¨è¿è¡Œçš„ Unit
$ systemctl list-units

# åˆ—å‡ºæ‰€æœ‰Unitï¼ŒåŒ…æ‹¬æ²¡æœ‰æ‰¾åˆ°é…ç½®æ–‡ä»¶çš„æˆ–è€…å¯åŠ¨å¤±è´¥çš„
$ systemctl list-units --all

# åˆ—å‡ºæ‰€æœ‰æ²¡æœ‰è¿è¡Œçš„ Unit
$ systemctl list-units --all --state=inactive

# åˆ—å‡ºæ‰€æœ‰åŠ è½½å¤±è´¥çš„ Unit
$ systemctl list-units --failed

# åˆ—å‡ºæ‰€æœ‰æ­£åœ¨è¿è¡Œçš„ã€ç±»åž‹ä¸º service çš„ Unit
$ systemctl list-units --type=service
```

#### Unit çš„çŠ¶æ€

`systemctl status`å‘½ä»¤ç”¨äºŽæŸ¥çœ‹ç³»ç»ŸçŠ¶æ€å’Œå•ä¸ª Unit çš„çŠ¶æ€ã€‚

```bash
# æ˜¾ç¤ºç³»ç»ŸçŠ¶æ€
$ systemctl status

# æ˜¾ç¤ºå•ä¸ª Unit çš„çŠ¶æ€
$ sysystemctl status bluetooth.service

# æ˜¾ç¤ºè¿œç¨‹ä¸»æœºçš„æŸä¸ª Unit çš„çŠ¶æ€
$ systemctl -H root@rhel7.example.com status httpd.service
```

é™¤äº†`status`å‘½ä»¤ï¼Œ`systemctl`è¿˜æä¾›äº†ä¸‰ä¸ªæŸ¥è¯¢çŠ¶æ€çš„ç®€å•æ–¹æ³•ï¼Œä¸»è¦ä¾›è„šæœ¬å†…éƒ¨çš„åˆ¤æ–­è¯­å¥ä½¿ç”¨ã€‚

```bash
# æ˜¾ç¤ºæŸä¸ª Unit æ˜¯å¦æ­£åœ¨è¿è¡Œ
$ systemctl is-active application.service

# æ˜¾ç¤ºæŸä¸ª Unit æ˜¯å¦å¤„äºŽå¯åŠ¨å¤±è´¥çŠ¶æ€
$ systemctl is-failed application.service

# æ˜¾ç¤ºæŸä¸ª Unit æœåŠ¡æ˜¯å¦å»ºç«‹äº†å¯åŠ¨é“¾æŽ¥
$ systemctl is-enabled application.service
```

#### Unit ç®¡ç†â¤ï¸

å¯¹äºŽç”¨æˆ·æ¥è¯´ï¼Œæœ€å¸¸ç”¨çš„æ˜¯ä¸‹é¢è¿™äº›å‘½ä»¤ï¼Œç”¨äºŽå¯åŠ¨å’Œåœæ­¢ Unitï¼ˆä¸»è¦æ˜¯ serviceï¼‰ã€‚

```bash
# ç«‹å³å¯åŠ¨ä¸€ä¸ªæœåŠ¡
$ sudo systemctl start apache.service

# ç«‹å³åœæ­¢ä¸€ä¸ªæœåŠ¡
$ sudo systemctl stop apache.service

# é‡å¯ä¸€ä¸ªæœåŠ¡
$ sudo systemctl restart apache.service

# æ€æ­»ä¸€ä¸ªæœåŠ¡çš„æ‰€æœ‰å­è¿›ç¨‹
$ sudo systemctl kill apache.service

# é‡æ–°åŠ è½½ä¸€ä¸ªæœåŠ¡çš„é…ç½®æ–‡ä»¶
$ sudo systemctl reload apache.service

# é‡è½½æ‰€æœ‰ä¿®æ”¹è¿‡çš„é…ç½®æ–‡ä»¶
$ sudo systemctl daemon-reload

# æ˜¾ç¤ºæŸä¸ª Unit çš„æ‰€æœ‰åº•å±‚å‚æ•°
$ systemctl show httpd.service

# æ˜¾ç¤ºæŸä¸ª Unit çš„æŒ‡å®šå±žæ€§çš„å€¼
$ systemctl show -p CPUShares httpd.service

# è®¾ç½®æŸä¸ª Unit çš„æŒ‡å®šå±žæ€§
$ sudo systemctl set-property httpd.service CPUShares=500
```

#### ä¾èµ–å…³ç³»

Unit ä¹‹é—´å­˜åœ¨ä¾èµ–å…³ç³»ï¼šA ä¾èµ–äºŽ Bï¼Œå°±æ„å‘³ç€ Systemd åœ¨å¯åŠ¨ A çš„æ—¶å€™ï¼ŒåŒæ—¶ä¼šåŽ»å¯åŠ¨ Bã€‚

`systemctl list-dependencies`å‘½ä»¤åˆ—å‡ºä¸€ä¸ª Unit çš„æ‰€æœ‰ä¾èµ–ã€‚

```bash
systemctl list-dependencies nginx.service
```

ä¸Šé¢å‘½ä»¤çš„è¾“å‡ºç»“æžœä¹‹ä¸­ï¼Œæœ‰äº›ä¾èµ–æ˜¯ Target ç±»åž‹ï¼ˆè¯¦è§ä¸‹æ–‡ï¼‰ï¼Œé»˜è®¤ä¸ä¼šå±•å¼€æ˜¾ç¤ºã€‚å¦‚æžœè¦å±•å¼€ Targetï¼Œå°±éœ€è¦ä½¿ç”¨`--all`å‚æ•°ã€‚

```bash
systemctl list-dependencies --all nginx.service
```

#### Unitçš„é…ç½®æ–‡ä»¶

æ¯ä¸€ä¸ª Unit éƒ½æœ‰ä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œå‘Šè¯‰ Systemd æ€Žä¹ˆå¯åŠ¨è¿™ä¸ª Unit ã€‚

Systemd é»˜è®¤ä»Žç›®å½•`/etc/systemd/system/`è¯»å–é…ç½®æ–‡ä»¶ã€‚ä½†æ˜¯ï¼Œé‡Œé¢å­˜æ”¾çš„å¤§éƒ¨åˆ†æ–‡ä»¶éƒ½æ˜¯ç¬¦å·é“¾æŽ¥ï¼ŒæŒ‡å‘ç›®å½•`/usr/lib/systemd/system/`ï¼ŒçœŸæ­£çš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨é‚£ä¸ªç›®å½•ã€‚

`systemctl enable`å‘½ä»¤ç”¨äºŽåœ¨ä¸Šé¢ä¸¤ä¸ªç›®å½•ä¹‹é—´ï¼Œå»ºç«‹ç¬¦å·é“¾æŽ¥å…³ç³»ã€‚

```bash
$ sudo systemctl enable clamd@scan.service
# ç­‰åŒäºŽ
$ sudo ln -s '/usr/lib/systemd/system/clamd@scan.service' '/etc/systemd/system/multi-user.target.wants/clamd@scan.service'
```

å¦‚æžœé…ç½®æ–‡ä»¶é‡Œé¢è®¾ç½®äº†å¼€æœºå¯åŠ¨ï¼Œ`systemctl enable`å‘½ä»¤ç›¸å½“äºŽæ¿€æ´»å¼€æœºå¯åŠ¨ã€‚

ä¸Žä¹‹å¯¹åº”çš„ï¼Œ`systemctl disable`å‘½ä»¤ç”¨äºŽåœ¨ä¸¤ä¸ªç›®å½•ä¹‹é—´ï¼Œæ’¤é”€ç¬¦å·é“¾æŽ¥å…³ç³»ï¼Œç›¸å½“äºŽæ’¤é”€å¼€æœºå¯åŠ¨ã€‚

```bash
$ sudo systemctl disable clamd@scan.service
```

é…ç½®æ–‡ä»¶çš„åŽç¼€åï¼Œå°±æ˜¯è¯¥ Unit çš„ç§ç±»ï¼Œæ¯”å¦‚`sshd.socket`ã€‚å¦‚æžœçœç•¥ï¼ŒSystemd é»˜è®¤åŽç¼€åä¸º`.service`ï¼Œæ‰€ä»¥`sshd`ä¼šè¢«ç†è§£æˆ`sshd.service`ã€‚

##### é…ç½®æ–‡ä»¶çš„çŠ¶æ€

`systemctl list-unit-files`å‘½ä»¤ç”¨äºŽåˆ—å‡ºæ‰€æœ‰é…ç½®æ–‡ä»¶ã€‚

ðŸ”–

##### é…ç½®æ–‡ä»¶çš„æ ¼å¼



##### é…ç½®æ–‡ä»¶çš„åŒºå—

`[Unit]`åŒºå—é€šå¸¸æ˜¯é…ç½®æ–‡ä»¶çš„ç¬¬ä¸€ä¸ªåŒºå—ï¼Œç”¨æ¥å®šä¹‰ Unit çš„å…ƒæ•°æ®ï¼Œä»¥åŠé…ç½®ä¸Žå…¶ä»– Unit çš„å…³ç³»ã€‚å®ƒçš„ä¸»è¦å­—æ®µå¦‚ä¸‹ã€‚

- `Description`ï¼šç®€çŸ­æè¿°
- `Documentation`ï¼šæ–‡æ¡£åœ°å€
- `Requires`ï¼šå½“å‰ Unit ä¾èµ–çš„å…¶ä»– Unitï¼Œå¦‚æžœå®ƒä»¬æ²¡æœ‰è¿è¡Œï¼Œå½“å‰ Unit ä¼šå¯åŠ¨å¤±è´¥
- `Wants`ï¼šä¸Žå½“å‰ Unit é…åˆçš„å…¶ä»– Unitï¼Œå¦‚æžœå®ƒä»¬æ²¡æœ‰è¿è¡Œï¼Œå½“å‰ Unit ä¸ä¼šå¯åŠ¨å¤±è´¥
- `BindsTo`ï¼šä¸Ž`Requires`ç±»ä¼¼ï¼Œå®ƒæŒ‡å®šçš„ Unit å¦‚æžœé€€å‡ºï¼Œä¼šå¯¼è‡´å½“å‰ Unit åœæ­¢è¿è¡Œ
- `Before`ï¼šå¦‚æžœè¯¥å­—æ®µæŒ‡å®šçš„ Unit ä¹Ÿè¦å¯åŠ¨ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨å½“å‰ Unit ä¹‹åŽå¯åŠ¨
- `After`ï¼šå¦‚æžœè¯¥å­—æ®µæŒ‡å®šçš„ Unit ä¹Ÿè¦å¯åŠ¨ï¼Œé‚£ä¹ˆå¿…é¡»åœ¨å½“å‰ Unit ä¹‹å‰å¯åŠ¨
- `Conflicts`ï¼šè¿™é‡ŒæŒ‡å®šçš„ Unit ä¸èƒ½ä¸Žå½“å‰ Unit åŒæ—¶è¿è¡Œ
- `Condition...`ï¼šå½“å‰ Unit è¿è¡Œå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼Œå¦åˆ™ä¸ä¼šè¿è¡Œ
- `Assert...`ï¼šå½“å‰ Unit è¿è¡Œå¿…é¡»æ»¡è¶³çš„æ¡ä»¶ï¼Œå¦åˆ™ä¼šæŠ¥å¯åŠ¨å¤±è´¥

`[Install]`é€šå¸¸æ˜¯é…ç½®æ–‡ä»¶çš„æœ€åŽä¸€ä¸ªåŒºå—ï¼Œç”¨æ¥å®šä¹‰å¦‚ä½•å¯åŠ¨ï¼Œä»¥åŠæ˜¯å¦å¼€æœºå¯åŠ¨ã€‚å®ƒçš„ä¸»è¦å­—æ®µå¦‚ä¸‹ã€‚

- `WantedBy`ï¼šå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼ˆenableï¼‰ç¬¦å·é“¾æŽ¥ä¼šæ”¾å…¥`/etc/systemd/system`ç›®å½•ä¸‹é¢ä»¥ Target å + `.wants`åŽç¼€æž„æˆçš„å­ç›®å½•ä¸­
- `RequiredBy`ï¼šå®ƒçš„å€¼æ˜¯ä¸€ä¸ªæˆ–å¤šä¸ª Targetï¼Œå½“å‰ Unit æ¿€æ´»æ—¶ï¼Œç¬¦å·é“¾æŽ¥ä¼šæ”¾å…¥`/etc/systemd/system`ç›®å½•ä¸‹é¢ä»¥ Target å + `.required`åŽç¼€æž„æˆçš„å­ç›®å½•ä¸­
- `Alias`ï¼šå½“å‰ Unit å¯ç”¨äºŽå¯åŠ¨çš„åˆ«å
- `Also`ï¼šå½“å‰ Unit æ¿€æ´»ï¼ˆenableï¼‰æ—¶ï¼Œä¼šè¢«åŒæ—¶æ¿€æ´»çš„å…¶ä»– Unit

`[Service]`åŒºå—ç”¨æ¥ Service çš„é…ç½®ï¼Œåªæœ‰ Service ç±»åž‹çš„ Unit æ‰æœ‰è¿™ä¸ªåŒºå—ã€‚å®ƒçš„ä¸»è¦å­—æ®µå¦‚ä¸‹ã€‚

- `Type`ï¼šå®šä¹‰å¯åŠ¨æ—¶çš„è¿›ç¨‹è¡Œä¸ºã€‚å®ƒæœ‰ä»¥ä¸‹å‡ ç§å€¼ã€‚
- `Type=simple`ï¼šé»˜è®¤å€¼ï¼Œæ‰§è¡Œ`ExecStart`æŒ‡å®šçš„å‘½ä»¤ï¼Œå¯åŠ¨ä¸»è¿›ç¨‹
- `Type=forking`ï¼šä»¥ fork æ–¹å¼ä»Žçˆ¶è¿›ç¨‹åˆ›å»ºå­è¿›ç¨‹ï¼Œåˆ›å»ºåŽçˆ¶è¿›ç¨‹ä¼šç«‹å³é€€å‡º
- `Type=oneshot`ï¼šä¸€æ¬¡æ€§è¿›ç¨‹ï¼ŒSystemd ä¼šç­‰å½“å‰æœåŠ¡é€€å‡ºï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
- `Type=dbus`ï¼šå½“å‰æœåŠ¡é€šè¿‡D-Buså¯åŠ¨
- `Type=notify`ï¼šå½“å‰æœåŠ¡å¯åŠ¨å®Œæ¯•ï¼Œä¼šé€šçŸ¥`Systemd`ï¼Œå†ç»§ç»­å¾€ä¸‹æ‰§è¡Œ
- `Type=idle`ï¼šè‹¥æœ‰å…¶ä»–ä»»åŠ¡æ‰§è¡Œå®Œæ¯•ï¼Œå½“å‰æœåŠ¡æ‰ä¼šè¿è¡Œ
- `ExecStart`ï¼šå¯åŠ¨å½“å‰æœåŠ¡çš„å‘½ä»¤
- `ExecStartPre`ï¼šå¯åŠ¨å½“å‰æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤
- `ExecStartPost`ï¼šå¯åŠ¨å½“å‰æœåŠ¡ä¹‹åŽæ‰§è¡Œçš„å‘½ä»¤
- `ExecReload`ï¼šé‡å¯å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
- `ExecStop`ï¼šåœæ­¢å½“å‰æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
- `ExecStopPost`ï¼šåœæ­¢å½“å…¶æœåŠ¡ä¹‹åŽæ‰§è¡Œçš„å‘½ä»¤
- `RestartSec`ï¼šè‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡é—´éš”çš„ç§’æ•°
- `Restart`ï¼šå®šä¹‰ä½•ç§æƒ…å†µ Systemd ä¼šè‡ªåŠ¨é‡å¯å½“å‰æœåŠ¡ï¼Œå¯èƒ½çš„å€¼åŒ…æ‹¬`always`ï¼ˆæ€»æ˜¯é‡å¯ï¼‰ã€`on-success`ã€`on-failure`ã€`on-abnormal`ã€`on-abort`ã€`on-watchdog`
- `TimeoutSec`ï¼šå®šä¹‰ Systemd åœæ­¢å½“å‰æœåŠ¡ä¹‹å‰ç­‰å¾…çš„ç§’æ•°
- `Environment`ï¼šæŒ‡å®šçŽ¯å¢ƒå˜é‡

[Unité…ç½®æ–‡ä»¶çš„å®Œæ•´å­—æ®µæ¸…å•çš„å®˜æ–¹æ–‡æ¡£](https://www.freedesktop.org/software/systemd/man/systemd.unit.html)ã€‚



### Target

å¯åŠ¨è®¡ç®—æœºçš„æ—¶å€™ï¼Œéœ€è¦å¯åŠ¨å¤§é‡çš„ Unitã€‚å¦‚æžœæ¯ä¸€æ¬¡å¯åŠ¨ï¼Œéƒ½è¦ä¸€ä¸€å†™æ˜Žæœ¬æ¬¡å¯åŠ¨éœ€è¦å“ªäº› Unitï¼Œæ˜¾ç„¶éžå¸¸ä¸æ–¹ä¾¿ã€‚Systemd çš„è§£å†³æ–¹æ¡ˆå°±æ˜¯ Targetã€‚

ç®€å•è¯´ï¼Œ**Target å°±æ˜¯ä¸€ä¸ª Unit ç»„ï¼ŒåŒ…å«è®¸å¤šç›¸å…³çš„ Unit** ã€‚å¯åŠ¨æŸä¸ª Target çš„æ—¶å€™ï¼ŒSystemd å°±ä¼šå¯åŠ¨é‡Œé¢æ‰€æœ‰çš„ Unitã€‚ä»Žè¿™ä¸ªæ„ä¹‰ä¸Šè¯´ï¼ŒTarget è¿™ä¸ªæ¦‚å¿µç±»ä¼¼äºŽ"çŠ¶æ€ç‚¹"ï¼Œå¯åŠ¨æŸä¸ª Target å°±å¥½æ¯”å¯åŠ¨åˆ°æŸç§çŠ¶æ€ã€‚

ä¼ ç»Ÿçš„`init`å¯åŠ¨æ¨¡å¼é‡Œé¢ï¼Œæœ‰ RunLevel çš„æ¦‚å¿µï¼Œè·Ÿ Target çš„ä½œç”¨å¾ˆç±»ä¼¼ã€‚ä¸åŒçš„æ˜¯ï¼ŒRunLevel æ˜¯äº’æ–¥çš„ï¼Œä¸å¯èƒ½å¤šä¸ª RunLevel åŒæ—¶å¯åŠ¨ï¼Œä½†æ˜¯å¤šä¸ª Target å¯ä»¥åŒæ—¶å¯åŠ¨ã€‚

```bash
# æŸ¥çœ‹å½“å‰ç³»ç»Ÿçš„æ‰€æœ‰ Target
$ systemctl list-unit-files --type=target

# æŸ¥çœ‹ä¸€ä¸ª Target åŒ…å«çš„æ‰€æœ‰ Unit
$ systemctl list-dependencies multi-user.target

# æŸ¥çœ‹å¯åŠ¨æ—¶çš„é»˜è®¤ Target
$ systemctl get-default

# è®¾ç½®å¯åŠ¨æ—¶çš„é»˜è®¤ Target
$ sudo systemctl set-default multi-user.target

# åˆ‡æ¢ Target æ—¶ï¼Œé»˜è®¤ä¸å…³é—­å‰ä¸€ä¸ª Target å¯åŠ¨çš„è¿›ç¨‹ï¼Œ
# systemctl isolate å‘½ä»¤æ”¹å˜è¿™ç§è¡Œä¸ºï¼Œ
# å…³é—­å‰ä¸€ä¸ª Target é‡Œé¢æ‰€æœ‰ä¸å±žäºŽåŽä¸€ä¸ª Target çš„è¿›ç¨‹
$ sudo systemctl isolate multi-user.target
```

Target ä¸Ž ä¼ ç»Ÿ RunLevel çš„å¯¹åº”å…³ç³»å¦‚ä¸‹ã€‚

```bash
Traditional runlevel      New target name     Symbolically linked to...

Runlevel 0           |    runlevel0.target -> poweroff.target
Runlevel 1           |    runlevel1.target -> rescue.target
Runlevel 2           |    runlevel2.target -> multi-user.target
Runlevel 3           |    runlevel3.target -> multi-user.target
Runlevel 4           |    runlevel4.target -> multi-user.target
Runlevel 5           |    runlevel5.target -> graphical.target
Runlevel 6           |    runlevel6.target -> reboot.target
```

å®ƒä¸Ž`init`è¿›ç¨‹çš„ä¸»è¦å·®åˆ«å¦‚ä¸‹ã€‚

1. é»˜è®¤çš„ RunLevelï¼ˆåœ¨/etc/inittabæ–‡ä»¶è®¾ç½®ï¼‰çŽ°åœ¨è¢«é»˜è®¤çš„ Target å–ä»£ï¼Œä½ç½®æ˜¯/etc/systemd/system/default.targetï¼Œé€šå¸¸ç¬¦å·é“¾æŽ¥åˆ°graphical.targetï¼ˆå›¾å½¢ç•Œé¢ï¼‰æˆ–è€…multi-user.targetï¼ˆå¤šç”¨æˆ·å‘½ä»¤è¡Œï¼‰ã€‚
2. å¯åŠ¨è„šæœ¬çš„ä½ç½®ï¼Œä»¥å‰æ˜¯/etc/init.dç›®å½•ï¼Œç¬¦å·é“¾æŽ¥åˆ°ä¸åŒçš„ RunLevel ç›®å½• ï¼ˆæ¯”å¦‚/etc/rc3.dã€/etc/rc5.dç­‰ï¼‰ï¼ŒçŽ°åœ¨åˆ™å­˜æ”¾åœ¨/lib/systemd/systemå’Œ/etc/systemd/systemç›®å½•ã€‚
3. é…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œä»¥å‰initè¿›ç¨‹çš„é…ç½®æ–‡ä»¶æ˜¯/etc/inittabï¼Œå„ç§æœåŠ¡çš„é…ç½®æ–‡ä»¶å­˜æ”¾åœ¨/etc/sysconfigç›®å½•ã€‚çŽ°åœ¨çš„é…ç½®æ–‡ä»¶ä¸»è¦å­˜æ”¾åœ¨/lib/systemdç›®å½•ï¼Œåœ¨/etc/systemdç›®å½•é‡Œé¢çš„ä¿®æ”¹å¯ä»¥è¦†ç›–åŽŸå§‹è®¾ç½®ã€‚

### æ—¥å¿—ç®¡ç†

Systemd ç»Ÿä¸€ç®¡ç†æ‰€æœ‰ Unit çš„å¯åŠ¨æ—¥å¿—ã€‚å¸¦æ¥çš„å¥½å¤„å°±æ˜¯ï¼Œå¯ä»¥åªç”¨`journalctl`ä¸€ä¸ªå‘½ä»¤ï¼ŒæŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼ˆå†…æ ¸æ—¥å¿—å’Œåº”ç”¨æ—¥å¿—ï¼‰ã€‚æ—¥å¿—çš„é…ç½®æ–‡ä»¶æ˜¯`/etc/systemd/journald.conf`ã€‚

`journalctl`åŠŸèƒ½å¼ºå¤§ï¼Œç”¨æ³•éžå¸¸å¤šã€‚

```bash
# æŸ¥çœ‹æ‰€æœ‰æ—¥å¿—ï¼ˆé»˜è®¤æƒ…å†µä¸‹ ï¼Œåªä¿å­˜æœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼‰
$ sudo journalctl

# æŸ¥çœ‹å†…æ ¸æ—¥å¿—ï¼ˆä¸æ˜¾ç¤ºåº”ç”¨æ—¥å¿—ï¼‰
$ sudo journalctl -k

# æŸ¥çœ‹ç³»ç»Ÿæœ¬æ¬¡å¯åŠ¨çš„æ—¥å¿—
$ sudo journalctl -b
$ sudo journalctl -b -0

# æŸ¥çœ‹ä¸Šä¸€æ¬¡å¯åŠ¨çš„æ—¥å¿—ï¼ˆéœ€æ›´æ”¹è®¾ç½®ï¼‰
$ sudo journalctl -b -1

# æŸ¥çœ‹æŒ‡å®šæ—¶é—´çš„æ—¥å¿—
$ sudo journalctl --since="2012-10-30 18:17:16"
$ sudo journalctl --since "20 min ago"
$ sudo journalctl --since yesterday
$ sudo journalctl --since "2015-01-10" --until "2015-01-11 03:00"
$ sudo journalctl --since 09:00 --until "1 hour ago"

# æ˜¾ç¤ºå°¾éƒ¨çš„æœ€æ–°10è¡Œæ—¥å¿—
$ sudo journalctl -n

# æ˜¾ç¤ºå°¾éƒ¨æŒ‡å®šè¡Œæ•°çš„æ—¥å¿—
$ sudo journalctl -n 20

# å®žæ—¶æ»šåŠ¨æ˜¾ç¤ºæœ€æ–°æ—¥å¿—
$ sudo journalctl -f

# æŸ¥çœ‹æŒ‡å®šæœåŠ¡çš„æ—¥å¿—
$ sudo journalctl /usr/lib/systemd/systemd

# æŸ¥çœ‹æŒ‡å®šè¿›ç¨‹çš„æ—¥å¿—
$ sudo journalctl _PID=1

# æŸ¥çœ‹æŸä¸ªè·¯å¾„çš„è„šæœ¬çš„æ—¥å¿—
$ sudo journalctl /usr/bin/bash

# æŸ¥çœ‹æŒ‡å®šç”¨æˆ·çš„æ—¥å¿—
$ sudo journalctl _UID=33 --since today

# æŸ¥çœ‹æŸä¸ª Unit çš„æ—¥å¿—
$ sudo journalctl -u nginx.service
$ sudo journalctl -u nginx.service --since today

# å®žæ—¶æ»šåŠ¨æ˜¾ç¤ºæŸä¸ª Unit çš„æœ€æ–°æ—¥å¿—
$ sudo journalctl -u nginx.service -f

# åˆå¹¶æ˜¾ç¤ºå¤šä¸ª Unit çš„æ—¥å¿—
$ journalctl -u nginx.service -u php-fpm.service --since today

# æŸ¥çœ‹æŒ‡å®šä¼˜å…ˆçº§ï¼ˆåŠå…¶ä»¥ä¸Šçº§åˆ«ï¼‰çš„æ—¥å¿—ï¼Œå…±æœ‰8çº§
# 0: emerg
# 1: alert
# 2: crit
# 3: err
# 4: warning
# 5: notice
# 6: info
# 7: debug
$ sudo journalctl -p err -b

# æ—¥å¿—é»˜è®¤åˆ†é¡µè¾“å‡ºï¼Œ--no-pager æ”¹ä¸ºæ­£å¸¸çš„æ ‡å‡†è¾“å‡º
$ sudo journalctl --no-pager

# ä»¥ JSON æ ¼å¼ï¼ˆå•è¡Œï¼‰è¾“å‡º
$ sudo journalctl -b -u nginx.service -o json

# ä»¥ JSON æ ¼å¼ï¼ˆå¤šè¡Œï¼‰è¾“å‡ºï¼Œå¯è¯»æ€§æ›´å¥½
$ sudo journalctl -b -u nginx.serviceqq
 -o json-pretty

# æ˜¾ç¤ºæ—¥å¿—å æ®çš„ç¡¬ç›˜ç©ºé—´
$ sudo journalctl --disk-usage

# æŒ‡å®šæ—¥å¿—æ–‡ä»¶å æ®çš„æœ€å¤§ç©ºé—´
$ sudo journalctl --vacuum-size=1G

# æŒ‡å®šæ—¥å¿—æ–‡ä»¶ä¿å­˜å¤šä¹…
$ sudo journalctl --vacuum-time=1years
```

### Systemdå®žæˆ˜

#### å¼€æœºå¯åŠ¨

å¯¹äºŽé‚£äº›æ”¯æŒ Systemd çš„è½¯ä»¶ï¼Œå®‰è£…çš„æ—¶å€™ï¼Œä¼šè‡ªåŠ¨åœ¨`/usr/lib/systemd/system`ç›®å½•æ·»åŠ ä¸€ä¸ªé…ç½®æ–‡ä»¶ã€‚

å¦‚æžœä½ æƒ³è®©è¯¥è½¯ä»¶å¼€æœºå¯åŠ¨ï¼Œå°±æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤ï¼ˆä»¥`httpd.service`ä¸ºä¾‹ï¼‰ã€‚

```bash
$ sudo systemctl enable httpd
```

ä¸Šé¢çš„å‘½ä»¤ç›¸å½“äºŽåœ¨`/etc/systemd/system`ç›®å½•æ·»åŠ ä¸€ä¸ªç¬¦å·é“¾æŽ¥ï¼ŒæŒ‡å‘`/usr/lib/systemd/system`é‡Œé¢çš„`httpd.service`æ–‡ä»¶ã€‚

è¿™æ˜¯å› ä¸ºå¼€æœºæ—¶ï¼Œ`Systemd`åªæ‰§è¡Œ`/etc/systemd/system`ç›®å½•é‡Œé¢çš„é…ç½®æ–‡ä»¶ã€‚è¿™ä¹Ÿæ„å‘³ç€ï¼Œå¦‚æžœæŠŠä¿®æ”¹åŽçš„é…ç½®æ–‡ä»¶æ”¾åœ¨è¯¥ç›®å½•ï¼Œå°±å¯ä»¥è¾¾åˆ°è¦†ç›–åŽŸå§‹é…ç½®çš„æ•ˆæžœã€‚

#### å¯åŠ¨æœåŠ¡

è®¾ç½®å¼€æœºå¯åŠ¨ä»¥åŽï¼Œè½¯ä»¶å¹¶ä¸ä¼šç«‹å³å¯åŠ¨ï¼Œå¿…é¡»ç­‰åˆ°ä¸‹ä¸€æ¬¡å¼€æœºã€‚å¦‚æžœæƒ³çŽ°åœ¨å°±è¿è¡Œè¯¥è½¯ä»¶ï¼Œé‚£ä¹ˆè¦æ‰§è¡Œsystemctl startå‘½ä»¤ã€‚

```bash
$ sudo systemctl start httpd
```


æ‰§è¡Œä¸Šé¢çš„å‘½ä»¤ä»¥åŽï¼Œæœ‰å¯èƒ½å¯åŠ¨å¤±è´¥ï¼Œå› æ­¤è¦ç”¨systemctl statuså‘½ä»¤æŸ¥çœ‹ä¸€ä¸‹è¯¥æœåŠ¡çš„çŠ¶æ€ã€‚

```bash
$ sudo systemctl status httpd

httpd.service - The Apache HTTP Server
   Loaded: loaded (/usr/lib/systemd/system/httpd.service; enabled)
   Active: active (running) since é‡‘ 2014-12-05 12:18:22 JST; 7min ago
 Main PID: 4349 (httpd)
   Status: "Total requests: 1; Current requests/sec: 0; Current traffic:   0 B/sec"
   CGroup: /system.slice/httpd.service
           â”œâ”€4349 /usr/sbin/httpd -DFOREGROUND
           â”œâ”€4350 /usr/sbin/httpd -DFOREGROUND
           â”œâ”€4351 /usr/sbin/httpd -DFOREGROUND
           â”œâ”€4352 /usr/sbin/httpd -DFOREGROUND
           â”œâ”€4353 /usr/sbin/httpd -DFOREGROUND
           â””â”€4354 /usr/sbin/httpd -DFOREGROUND

12æœˆ 05 12:18:22 localhost.localdomain systemd[1]: Starting The Apache HTTP Server...
12æœˆ 05 12:18:22 localhost.localdomain systemd[1]: Started The Apache HTTP Server.
12æœˆ 05 12:22:40 localhost.localdomain systemd[1]: Started The Apache HTTP Server.
```

ä¸Šé¢çš„è¾“å‡ºç»“æžœå«ä¹‰å¦‚ä¸‹ã€‚

- Loadedè¡Œï¼šé…ç½®æ–‡ä»¶çš„ä½ç½®ï¼Œæ˜¯å¦è®¾ä¸ºå¼€æœºå¯åŠ¨
- Activeè¡Œï¼šè¡¨ç¤ºæ­£åœ¨è¿è¡Œ
- Main PIDè¡Œï¼šä¸»è¿›ç¨‹ID
- Statusè¡Œï¼šç”±åº”ç”¨æœ¬èº«ï¼ˆè¿™é‡Œæ˜¯ httpd ï¼‰æä¾›çš„è½¯ä»¶å½“å‰çŠ¶æ€
- CGroupå—ï¼šåº”ç”¨çš„æ‰€æœ‰å­è¿›ç¨‹
- æ—¥å¿—å—ï¼šåº”ç”¨çš„æ—¥å¿—

#### åœæ­¢æœåŠ¡

ç»ˆæ­¢æ­£åœ¨è¿è¡Œçš„æœåŠ¡ï¼Œéœ€è¦æ‰§è¡Œ`systemctl stop`å‘½ä»¤ã€‚

> ```bash
> $ sudo systemctl stop httpd.service
> ```

æœ‰æ—¶å€™ï¼Œè¯¥å‘½ä»¤å¯èƒ½æ²¡æœ‰å“åº”ï¼ŒæœåŠ¡åœä¸ä¸‹æ¥ã€‚è¿™æ—¶å€™å°±ä¸å¾—ä¸"æ€è¿›ç¨‹"äº†ï¼Œå‘æ­£åœ¨è¿è¡Œçš„è¿›ç¨‹å‘å‡º`kill`ä¿¡å·ã€‚

> ```bash
> $ sudo systemctl kill httpd.service
> ```

æ­¤å¤–ï¼Œé‡å¯æœåŠ¡è¦æ‰§è¡Œ`systemctl restart`å‘½ä»¤ã€‚

> ```bash
> $ sudo systemctl restart httpd.service
> ```

#### è¯»æ‡‚é…ç½®æ–‡ä»¶

ä¸€ä¸ªæœåŠ¡æ€Žä¹ˆå¯åŠ¨ï¼Œå®Œå…¨ç”±å®ƒçš„é…ç½®æ–‡ä»¶å†³å®šã€‚ä¸‹é¢å°±æ¥çœ‹ï¼Œé…ç½®æ–‡ä»¶æœ‰äº›ä»€ä¹ˆå†…å®¹ã€‚

å‰é¢è¯´è¿‡ï¼Œé…ç½®æ–‡ä»¶ä¸»è¦æ”¾åœ¨`/usr/lib/systemd/system`ç›®å½•ï¼Œä¹Ÿå¯èƒ½åœ¨`/etc/systemd/system`ç›®å½•ã€‚æ‰¾åˆ°é…ç½®æ–‡ä»¶ä»¥åŽï¼Œä½¿ç”¨æ–‡æœ¬ç¼–è¾‘å™¨æ‰“å¼€å³å¯ã€‚

`systemctl cat`å‘½ä»¤å¯ä»¥ç”¨æ¥æŸ¥çœ‹é…ç½®æ–‡ä»¶ï¼Œä¸‹é¢ä»¥`sshd.service`æ–‡ä»¶ä¸ºä¾‹ï¼Œå®ƒçš„ä½œç”¨æ˜¯å¯åŠ¨ä¸€ä¸ª SSH æœåŠ¡å™¨ï¼Œä¾›å…¶ä»–ç”¨æˆ·ä»¥ SSH æ–¹å¼ç™»å½•ã€‚

> ```bash
> $ systemctl cat sshd.service
> 
> [Unit]
> Description=OpenSSH server daemon
> Documentation=man:sshd(8) man:sshd_config(5)
> After=network.target sshd-keygen.service
> Wants=sshd-keygen.service
> 
> [Service]
> EnvironmentFile=/etc/sysconfig/sshd
> ExecStart=/usr/sbin/sshd -D $OPTIONS
> ExecReload=/bin/kill -HUP $MAINPID
> Type=simple
> KillMode=process
> Restart=on-failure
> RestartSec=42s
> 
> [Install]
> WantedBy=multi-user.target
> ```

å¯ä»¥çœ‹åˆ°ï¼Œé…ç½®æ–‡ä»¶åˆ†æˆå‡ ä¸ªåŒºå—ï¼Œæ¯ä¸ªåŒºå—åŒ…å«è‹¥å¹²æ¡é”®å€¼å¯¹ã€‚

ä¸‹é¢ä¾æ¬¡è§£é‡Šæ¯ä¸ªåŒºå—çš„å†…å®¹ã€‚

#### [Unit] åŒºå—ï¼šå¯åŠ¨é¡ºåºä¸Žä¾èµ–å…³ç³»ã€‚

`Unit`åŒºå—çš„`Description`å­—æ®µç»™å‡ºå½“å‰æœåŠ¡çš„ç®€å•æè¿°ï¼Œ`Documentation`å­—æ®µç»™å‡ºæ–‡æ¡£ä½ç½®ã€‚

æŽ¥ä¸‹æ¥çš„è®¾ç½®æ˜¯å¯åŠ¨é¡ºåºå’Œä¾èµ–å…³ç³»ï¼Œè¿™ä¸ªæ¯”è¾ƒé‡è¦ã€‚

> `After`å­—æ®µï¼šè¡¨ç¤ºå¦‚æžœ`network.target`æˆ–`sshd-keygen.service`éœ€è¦å¯åŠ¨ï¼Œé‚£ä¹ˆ`sshd.service`åº”è¯¥åœ¨å®ƒä»¬ä¹‹åŽå¯åŠ¨ã€‚

ç›¸åº”åœ°ï¼Œè¿˜æœ‰ä¸€ä¸ª`Before`å­—æ®µï¼Œå®šä¹‰`sshd.service`åº”è¯¥åœ¨å“ªäº›æœåŠ¡ä¹‹å‰å¯åŠ¨ã€‚

æ³¨æ„ï¼Œ`After`å’Œ`Before`å­—æ®µåªæ¶‰åŠå¯åŠ¨é¡ºåºï¼Œä¸æ¶‰åŠä¾èµ–å…³ç³»ã€‚

ä¸¾ä¾‹æ¥è¯´ï¼ŒæŸ Web åº”ç”¨éœ€è¦ postgresql æ•°æ®åº“å‚¨å­˜æ•°æ®ã€‚åœ¨é…ç½®æ–‡ä»¶ä¸­ï¼Œå®ƒåªå®šä¹‰è¦åœ¨ postgresql ä¹‹åŽå¯åŠ¨ï¼Œè€Œæ²¡æœ‰å®šä¹‰ä¾èµ– postgresql ã€‚ä¸Šçº¿åŽï¼Œç”±äºŽæŸç§åŽŸå› ï¼Œpostgresql éœ€è¦é‡æ–°å¯åŠ¨ï¼Œåœ¨åœæ­¢æœåŠ¡æœŸé—´ï¼Œè¯¥ Web åº”ç”¨å°±ä¼šæ— æ³•å»ºç«‹æ•°æ®åº“è¿žæŽ¥ã€‚

è®¾ç½®ä¾èµ–å…³ç³»ï¼Œéœ€è¦ä½¿ç”¨`Wants`å­—æ®µå’Œ`Requires`å­—æ®µã€‚

> `Wants`å­—æ®µï¼šè¡¨ç¤º`sshd.service`ä¸Ž`sshd-keygen.service`ä¹‹é—´å­˜åœ¨"å¼±ä¾èµ–"å…³ç³»ï¼Œå³å¦‚æžœ"sshd-keygen.service"å¯åŠ¨å¤±è´¥æˆ–åœæ­¢è¿è¡Œï¼Œä¸å½±å“`sshd.service`ç»§ç»­æ‰§è¡Œã€‚

`Requires`å­—æ®µåˆ™è¡¨ç¤º"å¼ºä¾èµ–"å…³ç³»ï¼Œå³å¦‚æžœè¯¥æœåŠ¡å¯åŠ¨å¤±è´¥æˆ–å¼‚å¸¸é€€å‡ºï¼Œé‚£ä¹ˆ`sshd.service`ä¹Ÿå¿…é¡»é€€å‡ºã€‚

æ³¨æ„ï¼Œ`Wants`å­—æ®µä¸Ž`Requires`å­—æ®µåªæ¶‰åŠä¾èµ–å…³ç³»ï¼Œä¸Žå¯åŠ¨é¡ºåºæ— å…³ï¼Œé»˜è®¤æƒ…å†µä¸‹æ˜¯åŒæ—¶å¯åŠ¨çš„ã€‚

#### [Service] åŒºå—ï¼šå¯åŠ¨è¡Œä¸º

`Service`åŒºå—å®šä¹‰å¦‚ä½•å¯åŠ¨å½“å‰æœåŠ¡ã€‚

##### å¯åŠ¨å‘½ä»¤

è®¸å¤šè½¯ä»¶éƒ½æœ‰è‡ªå·±çš„çŽ¯å¢ƒå‚æ•°æ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶å¯ä»¥ç”¨`EnvironmentFile`å­—æ®µè¯»å–ã€‚

> `EnvironmentFile`å­—æ®µï¼šæŒ‡å®šå½“å‰æœåŠ¡çš„çŽ¯å¢ƒå‚æ•°æ–‡ä»¶ã€‚è¯¥æ–‡ä»¶å†…éƒ¨çš„`key=value`é”®å€¼å¯¹ï¼Œå¯ä»¥ç”¨`$key`çš„å½¢å¼ï¼Œåœ¨å½“å‰é…ç½®æ–‡ä»¶ä¸­èŽ·å–ã€‚

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œsshd çš„çŽ¯å¢ƒå‚æ•°æ–‡ä»¶æ˜¯`/etc/sysconfig/sshd`ã€‚

é…ç½®æ–‡ä»¶é‡Œé¢æœ€é‡è¦çš„å­—æ®µæ˜¯`ExecStart`ã€‚

> `ExecStart`å­—æ®µï¼šå®šä¹‰å¯åŠ¨è¿›ç¨‹æ—¶æ‰§è¡Œçš„å‘½ä»¤ã€‚

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œå¯åŠ¨`sshd`ï¼Œæ‰§è¡Œçš„å‘½ä»¤æ˜¯`/usr/sbin/sshd -D $OPTIONS`ï¼Œå…¶ä¸­çš„å˜é‡`$OPTIONS`å°±æ¥è‡ª`EnvironmentFile`å­—æ®µæŒ‡å®šçš„çŽ¯å¢ƒå‚æ•°æ–‡ä»¶ã€‚

ä¸Žä¹‹ä½œç”¨ç›¸ä¼¼çš„ï¼Œè¿˜æœ‰å¦‚ä¸‹è¿™äº›å­—æ®µã€‚

> - `ExecReload`å­—æ®µï¼šé‡å¯æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
> - `ExecStop`å­—æ®µï¼šåœæ­¢æœåŠ¡æ—¶æ‰§è¡Œçš„å‘½ä»¤
> - `ExecStartPre`å­—æ®µï¼šå¯åŠ¨æœåŠ¡ä¹‹å‰æ‰§è¡Œçš„å‘½ä»¤
> - `ExecStartPost`å­—æ®µï¼šå¯åŠ¨æœåŠ¡ä¹‹åŽæ‰§è¡Œçš„å‘½ä»¤
> - `ExecStopPost`å­—æ®µï¼šåœæ­¢æœåŠ¡ä¹‹åŽæ‰§è¡Œçš„å‘½ä»¤

è¯·çœ‹ä¸‹é¢çš„ä¾‹å­ã€‚

> ```bash
> [Service]
> ExecStart=/bin/echo execstart1
> ExecStart=
> ExecStart=/bin/echo execstart2
> ExecStartPost=/bin/echo post1
> ExecStartPost=/bin/echo post2
> ```

ä¸Šé¢è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œç¬¬äºŒè¡Œ`ExecStart`è®¾ä¸ºç©ºå€¼ï¼Œç­‰äºŽå–æ¶ˆäº†ç¬¬ä¸€è¡Œçš„è®¾ç½®ï¼Œè¿è¡Œç»“æžœå¦‚ä¸‹ã€‚

> ```bash
> execstart2
> post1
> post2
> ```

æ‰€æœ‰çš„å¯åŠ¨è®¾ç½®ä¹‹å‰ï¼Œéƒ½å¯ä»¥åŠ ä¸Šä¸€ä¸ªè¿žè¯å·ï¼ˆ`-`ï¼‰ï¼Œè¡¨ç¤º"æŠ‘åˆ¶é”™è¯¯"ï¼Œå³å‘ç”Ÿé”™è¯¯çš„æ—¶å€™ï¼Œä¸å½±å“å…¶ä»–å‘½ä»¤çš„æ‰§è¡Œã€‚æ¯”å¦‚ï¼Œ`EnvironmentFile=-/etc/sysconfig/sshd`ï¼ˆæ³¨æ„ç­‰å·åŽé¢çš„é‚£ä¸ªè¿žè¯å·ï¼‰ï¼Œå°±è¡¨ç¤ºå³ä½¿`/etc/sysconfig/sshd`æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä¹Ÿä¸ä¼šæŠ›å‡ºé”™è¯¯ã€‚

##### å¯åŠ¨ç±»åž‹

`Type`å­—æ®µå®šä¹‰å¯åŠ¨ç±»åž‹ã€‚å®ƒå¯ä»¥è®¾ç½®çš„å€¼å¦‚ä¸‹ã€‚

> - simpleï¼ˆé»˜è®¤å€¼ï¼‰ï¼š`ExecStart`å­—æ®µå¯åŠ¨çš„è¿›ç¨‹ä¸ºä¸»è¿›ç¨‹
> - forkingï¼š`ExecStart`å­—æ®µå°†ä»¥`fork()`æ–¹å¼å¯åŠ¨ï¼Œæ­¤æ—¶çˆ¶è¿›ç¨‹å°†ä¼šé€€å‡ºï¼Œå­è¿›ç¨‹å°†æˆä¸ºä¸»è¿›ç¨‹
> - oneshotï¼šç±»ä¼¼äºŽ`simple`ï¼Œä½†åªæ‰§è¡Œä¸€æ¬¡ï¼ŒSystemd ä¼šç­‰å®ƒæ‰§è¡Œå®Œï¼Œæ‰å¯åŠ¨å…¶ä»–æœåŠ¡
> - dbusï¼šç±»ä¼¼äºŽ`simple`ï¼Œä½†ä¼šç­‰å¾… D-Bus ä¿¡å·åŽå¯åŠ¨
> - notifyï¼šç±»ä¼¼äºŽ`simple`ï¼Œå¯åŠ¨ç»“æŸåŽä¼šå‘å‡ºé€šçŸ¥ä¿¡å·ï¼Œç„¶åŽ Systemd å†å¯åŠ¨å…¶ä»–æœåŠ¡
> - idleï¼šç±»ä¼¼äºŽ`simple`ï¼Œä½†æ˜¯è¦ç­‰åˆ°å…¶ä»–ä»»åŠ¡éƒ½æ‰§è¡Œå®Œï¼Œæ‰ä¼šå¯åŠ¨è¯¥æœåŠ¡ã€‚ä¸€ç§ä½¿ç”¨åœºåˆæ˜¯ä¸ºè®©è¯¥æœåŠ¡çš„è¾“å‡ºï¼Œä¸ä¸Žå…¶ä»–æœåŠ¡çš„è¾“å‡ºç›¸æ··åˆ

ä¸‹é¢æ˜¯ä¸€ä¸ª`oneshot`çš„ä¾‹å­ï¼Œç¬”è®°æœ¬ç”µè„‘å¯åŠ¨æ—¶ï¼Œè¦æŠŠè§¦æ‘¸æ¿å…³æŽ‰ï¼Œé…ç½®æ–‡ä»¶å¯ä»¥è¿™æ ·å†™ã€‚

> ```bash
> [Unit]
> Description=Switch-off Touchpad
> 
> [Service]
> Type=oneshot
> ExecStart=/usr/bin/touchpad-off
> 
> [Install]
> WantedBy=multi-user.target
> ```

ä¸Šé¢çš„é…ç½®æ–‡ä»¶ï¼Œå¯åŠ¨ç±»åž‹è®¾ä¸º`oneshot`ï¼Œå°±è¡¨æ˜Žè¿™ä¸ªæœåŠ¡åªè¦è¿è¡Œä¸€æ¬¡å°±å¤Ÿäº†ï¼Œä¸éœ€è¦é•¿æœŸè¿è¡Œã€‚

å¦‚æžœå…³é—­ä»¥åŽï¼Œå°†æ¥æŸä¸ªæ—¶å€™è¿˜æƒ³æ‰“å¼€ï¼Œé…ç½®æ–‡ä»¶ä¿®æ”¹å¦‚ä¸‹ã€‚

> ```bash
> [Unit]
> Description=Switch-off Touchpad
> 
> [Service]
> Type=oneshot
> ExecStart=/usr/bin/touchpad-off start
> ExecStop=/usr/bin/touchpad-off stop
> RemainAfterExit=yes
> 
> [Install]
> WantedBy=multi-user.target
> ```

ä¸Šé¢é…ç½®æ–‡ä»¶ä¸­ï¼Œ`RemainAfterExit`å­—æ®µè®¾ä¸º`yes`ï¼Œè¡¨ç¤ºè¿›ç¨‹é€€å‡ºä»¥åŽï¼ŒæœåŠ¡ä»ç„¶ä¿æŒæ‰§è¡Œã€‚è¿™æ ·çš„è¯ï¼Œä¸€æ—¦ä½¿ç”¨`systemctl stop`å‘½ä»¤åœæ­¢æœåŠ¡ï¼Œ`ExecStop`æŒ‡å®šçš„å‘½ä»¤å°±ä¼šæ‰§è¡Œï¼Œä»Žè€Œé‡æ–°å¼€å¯è§¦æ‘¸æ¿ã€‚

##### é‡å¯è¡Œä¸º

`Service`åŒºå—æœ‰ä¸€äº›å­—æ®µï¼Œå®šä¹‰äº†é‡å¯è¡Œä¸ºã€‚

> `KillMode`å­—æ®µï¼šå®šä¹‰ Systemd å¦‚ä½•åœæ­¢ sshd æœåŠ¡ã€‚

ä¸Šé¢è¿™ä¸ªä¾‹å­ä¸­ï¼Œå°†`KillMode`è®¾ä¸º`process`ï¼Œè¡¨ç¤ºåªåœæ­¢ä¸»è¿›ç¨‹ï¼Œä¸åœæ­¢ä»»ä½•sshd å­è¿›ç¨‹ï¼Œå³å­è¿›ç¨‹æ‰“å¼€çš„ SSH session ä»ç„¶ä¿æŒè¿žæŽ¥ã€‚è¿™ä¸ªè®¾ç½®ä¸å¤ªå¸¸è§ï¼Œä½†å¯¹ sshd å¾ˆé‡è¦ï¼Œå¦åˆ™ä½ åœæ­¢æœåŠ¡çš„æ—¶å€™ï¼Œä¼šè¿žè‡ªå·±æ‰“å¼€çš„ SSH session ä¸€èµ·æ€æŽ‰ã€‚

`KillMode`å­—æ®µå¯ä»¥è®¾ç½®çš„å€¼å¦‚ä¸‹ã€‚

> - control-groupï¼ˆé»˜è®¤å€¼ï¼‰ï¼šå½“å‰æŽ§åˆ¶ç»„é‡Œé¢çš„æ‰€æœ‰å­è¿›ç¨‹ï¼Œéƒ½ä¼šè¢«æ€æŽ‰
> - processï¼šåªæ€ä¸»è¿›ç¨‹
> - mixedï¼šä¸»è¿›ç¨‹å°†æ”¶åˆ° SIGTERM ä¿¡å·ï¼Œå­è¿›ç¨‹æ”¶åˆ° SIGKILL ä¿¡å·
> - noneï¼šæ²¡æœ‰è¿›ç¨‹ä¼šè¢«æ€æŽ‰ï¼Œåªæ˜¯æ‰§è¡ŒæœåŠ¡çš„ stop å‘½ä»¤ã€‚

æŽ¥ä¸‹æ¥æ˜¯`Restart`å­—æ®µã€‚

> `Restart`å­—æ®µï¼šå®šä¹‰äº† sshd é€€å‡ºåŽï¼ŒSystemd çš„é‡å¯æ–¹å¼ã€‚

ä¸Šé¢çš„ä¾‹å­ä¸­ï¼Œ`Restart`è®¾ä¸º`on-failure`ï¼Œè¡¨ç¤ºä»»ä½•æ„å¤–çš„å¤±è´¥ï¼Œå°±å°†é‡å¯sshdã€‚å¦‚æžœ sshd æ­£å¸¸åœæ­¢ï¼ˆæ¯”å¦‚æ‰§è¡Œ`systemctl stop`å‘½ä»¤ï¼‰ï¼Œå®ƒå°±ä¸ä¼šé‡å¯ã€‚

`Restart`å­—æ®µå¯ä»¥è®¾ç½®çš„å€¼å¦‚ä¸‹ã€‚

> - noï¼ˆé»˜è®¤å€¼ï¼‰ï¼šé€€å‡ºåŽä¸ä¼šé‡å¯
> - on-successï¼šåªæœ‰æ­£å¸¸é€€å‡ºæ—¶ï¼ˆé€€å‡ºçŠ¶æ€ç ä¸º0ï¼‰ï¼Œæ‰ä¼šé‡å¯
> - on-failureï¼šéžæ­£å¸¸é€€å‡ºæ—¶ï¼ˆé€€å‡ºçŠ¶æ€ç éž0ï¼‰ï¼ŒåŒ…æ‹¬è¢«ä¿¡å·ç»ˆæ­¢å’Œè¶…æ—¶ï¼Œæ‰ä¼šé‡å¯
> - on-abnormalï¼šåªæœ‰è¢«ä¿¡å·ç»ˆæ­¢å’Œè¶…æ—¶ï¼Œæ‰ä¼šé‡å¯
> - on-abortï¼šåªæœ‰åœ¨æ”¶åˆ°æ²¡æœ‰æ•æ‰åˆ°çš„ä¿¡å·ç»ˆæ­¢æ—¶ï¼Œæ‰ä¼šé‡å¯
> - on-watchdogï¼šè¶…æ—¶é€€å‡ºï¼Œæ‰ä¼šé‡å¯
> - alwaysï¼šä¸ç®¡æ˜¯ä»€ä¹ˆé€€å‡ºåŽŸå› ï¼Œæ€»æ˜¯é‡å¯

å¯¹äºŽå®ˆæŠ¤è¿›ç¨‹ï¼ŒæŽ¨èè®¾ä¸º`on-failure`ã€‚å¯¹äºŽé‚£äº›å…è®¸å‘ç”Ÿé”™è¯¯é€€å‡ºçš„æœåŠ¡ï¼Œå¯ä»¥è®¾ä¸º`on-abnormal`ã€‚

æœ€åŽæ˜¯`RestartSec`å­—æ®µã€‚

> `RestartSec`å­—æ®µï¼šè¡¨ç¤º Systemd é‡å¯æœåŠ¡ä¹‹å‰ï¼Œéœ€è¦ç­‰å¾…çš„ç§’æ•°ã€‚ä¸Šé¢çš„ä¾‹å­è®¾ä¸ºç­‰å¾…42ç§’ã€‚

#### [Install] åŒºå—

`Install`åŒºå—ï¼Œå®šä¹‰å¦‚ä½•å®‰è£…è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œå³æ€Žæ ·åšåˆ°å¼€æœºå¯åŠ¨ã€‚

> `WantedBy`å­—æ®µï¼šè¡¨ç¤ºè¯¥æœåŠ¡æ‰€åœ¨çš„ Targetã€‚

`Target`çš„å«ä¹‰æ˜¯æœåŠ¡ç»„ï¼Œè¡¨ç¤ºä¸€ç»„æœåŠ¡ã€‚`WantedBy=multi-user.target`æŒ‡çš„æ˜¯ï¼Œsshd æ‰€åœ¨çš„ Target æ˜¯`multi-user.target`ã€‚

è¿™ä¸ªè®¾ç½®éžå¸¸é‡è¦ï¼Œå› ä¸ºæ‰§è¡Œ`systemctl enable sshd.service`å‘½ä»¤æ—¶ï¼Œ`sshd.service`çš„ä¸€ä¸ªç¬¦å·é“¾æŽ¥ï¼Œå°±ä¼šæ”¾åœ¨`/etc/systemd/system`ç›®å½•ä¸‹é¢çš„`multi-user.target.wants`å­ç›®å½•ä¹‹ä¸­ã€‚

Systemd æœ‰é»˜è®¤çš„å¯åŠ¨ Targetã€‚

> ```bash
> $ systemctl get-default
> multi-user.target
> ```

ä¸Šé¢çš„ç»“æžœè¡¨ç¤ºï¼Œé»˜è®¤çš„å¯åŠ¨ Target æ˜¯`multi-user.target`ã€‚åœ¨è¿™ä¸ªç»„é‡Œçš„æ‰€æœ‰æœåŠ¡ï¼Œéƒ½å°†å¼€æœºå¯åŠ¨ã€‚è¿™å°±æ˜¯ä¸ºä»€ä¹ˆ`systemctl enable`å‘½ä»¤èƒ½è®¾ç½®å¼€æœºå¯åŠ¨çš„åŽŸå› ã€‚

ä½¿ç”¨ Target çš„æ—¶å€™ï¼Œ`systemctl list-dependencies`å‘½ä»¤å’Œ`systemctl isolate`å‘½ä»¤ä¹Ÿå¾ˆæœ‰ç”¨ã€‚

> ```bash
> # æŸ¥çœ‹ multi-user.target åŒ…å«çš„æ‰€æœ‰æœåŠ¡
> $ systemctl list-dependencies multi-user.target
> 
> # åˆ‡æ¢åˆ°å¦ä¸€ä¸ª target
> # shutdown.target å°±æ˜¯å…³æœºçŠ¶æ€
> $ sudo systemctl isolate shutdown.target
> ```

ä¸€èˆ¬æ¥è¯´ï¼Œå¸¸ç”¨çš„ Target æœ‰ä¸¤ä¸ªï¼šä¸€ä¸ªæ˜¯`multi-user.target`ï¼Œè¡¨ç¤ºå¤šç”¨æˆ·å‘½ä»¤è¡ŒçŠ¶æ€ï¼›å¦ä¸€ä¸ªæ˜¯`graphical.target`ï¼Œè¡¨ç¤ºå›¾å½¢ç”¨æˆ·çŠ¶æ€ï¼Œå®ƒä¾èµ–äºŽ`multi-user.target`ã€‚å®˜æ–¹æ–‡æ¡£æœ‰ä¸€å¼ éžå¸¸æ¸…æ™°çš„ [Target ä¾èµ–å…³ç³»å›¾](https://www.freedesktop.org/software/systemd/man/bootup.html#System Manager Bootup)ã€‚

#### Target çš„é…ç½®æ–‡ä»¶

Target ä¹Ÿæœ‰è‡ªå·±çš„é…ç½®æ–‡ä»¶ã€‚

> ```bash
> $ systemctl cat multi-user.target
> 
> [Unit]
> Description=Multi-User System
> Documentation=man:systemd.special(7)
> Requires=basic.target
> Conflicts=rescue.service rescue.target
> After=basic.target rescue.service rescue.target
> AllowIsolate=yes
> ```

æ³¨æ„ï¼ŒTarget é…ç½®æ–‡ä»¶é‡Œé¢æ²¡æœ‰å¯åŠ¨å‘½ä»¤ã€‚

ä¸Šé¢è¾“å‡ºç»“æžœä¸­ï¼Œä¸»è¦å­—æ®µå«ä¹‰å¦‚ä¸‹ã€‚

> `Requires`å­—æ®µï¼šè¦æ±‚`basic.target`ä¸€èµ·è¿è¡Œã€‚
>
> `Conflicts`å­—æ®µï¼šå†²çªå­—æ®µã€‚å¦‚æžœ`rescue.service`æˆ–`rescue.target`æ­£åœ¨è¿è¡Œï¼Œ`multi-user.target`å°±ä¸èƒ½è¿è¡Œï¼Œåä¹‹äº¦ç„¶ã€‚
>
> `After`ï¼šè¡¨ç¤º`multi-user.target`åœ¨`basic.target` ã€ `rescue.service`ã€ `rescue.target`ä¹‹åŽå¯åŠ¨ï¼Œå¦‚æžœå®ƒä»¬æœ‰å¯åŠ¨çš„è¯ã€‚
>
> `AllowIsolate`ï¼šå…è®¸ä½¿ç”¨`systemctl isolate`å‘½ä»¤åˆ‡æ¢åˆ°`multi-user.target`ã€‚

#### ä¿®æ”¹é…ç½®æ–‡ä»¶åŽé‡å¯

ä¿®æ”¹é…ç½®æ–‡ä»¶ä»¥åŽï¼Œéœ€è¦é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶ï¼Œç„¶åŽé‡æ–°å¯åŠ¨ç›¸å…³æœåŠ¡ã€‚

> ```bash
> # é‡æ–°åŠ è½½é…ç½®æ–‡ä»¶
> $ sudo systemctl daemon-reload
> 
> # é‡å¯ç›¸å…³æœåŠ¡
> $ sudo systemctl restart foobar
> ```

### Systemd å®šæ—¶å™¨ðŸ”–
